<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sources — Senior News Daily</title>
  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="assets/pills.css">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    main{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:1.6rem}
    .sub{opacity:.75;margin-top:6px}
    .divider{height:1px;background:color-mix(in oklab, canvastext 14%, canvas 86%);margin:16px 0}
    a.btn{display:inline-block;border:1px solid color-mix(in oklab, canvastext 18%, transparent);
      border-radius:10px;padding:8px 12px;text-decoration:none}
    #status{font-size:.9rem;opacity:.75;margin-top:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>Sources</h1>
        <div class="sub">Sites contributing articles in the past 30 days, with last-seen times.</div>
        <div id="status">Loading…</div>
      </div>
      <a class="btn" href="./">← Back to Home</a>
    </header>

    <div class="divider"></div>

    <section id="tray"><div class="sub">Loading sources…</div></section>
  </main>

  <script>
  (async function(){
    const el = document.getElementById('tray');
    const status = document.getElementById('status');

    function esc(s){return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
    function human(dtStr){
      try{
        const dt=new Date(dtStr), now=new Date();
        const t=dt.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
        const y=new Date(now); y.setDate(now.getDate()-1);
        if (dt.toDateString()===now.toDateString()) return `Today, ${t}`;
        if (dt.toDateString()===y.toDateString())   return `Yesterday, ${t}`;
        return dt.toLocaleString([], {month:'short', day:'numeric'}) + ", " + t;
      }catch(e){ return dtStr||""; }
    }
    function color(seed){
      seed = seed || "x"; let h=0; for(let i=0;i<seed.length;i++) h=(h*31+seed.charCodeAt(i))%360;
      return [`hsl(${h} 70% 94%)`,`hsl(${h} 70% 28%)`];
    }
    function rootPath(){ // e.g., https://architeketh.github.io/senior-news-daily/
      const {origin, pathname} = window.location;
      const base = pathname.replace(/[^/]*$/, ""); // drop filename (sources.html)
      return origin + base; // includes trailing slash
    }

    try{
      const jsonUrl = rootPath() + "data/sources.json";
      status.textContent = "Fetching: " + jsonUrl;

      const res = await fetch(jsonUrl, {cache:'no-store'});
      if(!res.ok){
        status.textContent += `\nFetch failed: ${res.status} ${res.statusText}`;
        el.innerHTML = '<div class="sub">No sources.json yet.</div>';
        return;
      }
      const data = await res.json();
      const sources = data.sources || [];
      status.textContent += `\nGenerated: ${data.generated_at || 'n/a'} • window_days: ${data.window_days || 'n/a'} • sources: ${sources.length}`;
      if(!sources.length){
        el.innerHTML = '<div class="sub">No sources found in the current window.</div>';
        return;
      }

      const tray = document.createElement('div'); tray.className='pill-tray';
      for(const v of sources){
        const [bg,fg]=color(v.domain||v.display||"x");
        const a=document.createElement('a');
        a.className='pill'; a.style.setProperty('--pill-bg',bg); a.style.setProperty('--pill-fg',fg);
        a.href=v.domain?`https://${v.domain}`:'#'; a.target='_blank'; a.rel='noopener';
        a.title=v.last_title ? `${v.last_title} (${v.last_link||''})` : (v.last_link||'');
        a.innerHTML = `
          <span class="pill-site">${esc(v.display||v.domain||"unknown")}</span>
          <span class="pill-dot" aria-hidden="true">•</span>
          <span class="pill-when">${esc(human(v.last_dt))}</span>
          <span class="pill-count" title="Articles in window">(${Number(v.count||0)})</span>
        `;
        tray.appendChild(a);
      }
      el.replaceChildren(tray);
    }catch(e){
      status.textContent += "\nJS error: " + (e && e.message ? e.message : e);
      el.innerHTML = '<div class="sub">Error loading sources.</div>';
      console.warn(e);
    }
  })();
  </script>
</body>
</html>
